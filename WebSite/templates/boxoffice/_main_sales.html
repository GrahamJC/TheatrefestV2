{% load crispy_forms_tags %}
{% load widget_tweaks %}

<div class="row">
    <div class="col-6">
        {% if not sale %}
            <div class="card mb-2">
                <h6 class="card-header">New Sale</h6>
                <div class="card-body">
                    {% crispy sale_start_form %}
                </div>
            </div>
            <div class="card">
                <h6 class="card-header">Sales Since Last Checkpoint)</h6>
                <div class="card-body">
                    <table class="table table-striped">
                        <thhead>
                            <tr>
                                <th>Sale No</th>
                                <th>Customer</th>
                                <th>Amount</th>
                            </tr>
                        </thhead>
                        <tbody>
                            {% for sale in sales %}
                                <tr>
                                    <td><a href="#" onclick="updateSalesTab('{% url "boxoffice:sale_select" sale.uuid %}')">{{ sale.id }}</a></td>
                                    <td>{{ sale.customer }}</td>
                                    <td>&#163;{{ sale.amount }}</td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        {% else %}
            <div class="card mb-2">
                <h6 class="card-header">Add Tickets</h6>
                <div class="card-body">
                    <div class="row form-group">
                        <label class="col-4 form-control-label">Show</label>
                        <div class="col-8">
                            <select id="sale-show-select" class="form-control" onchange="saleSelectShow(this.value)">
                                <option value="" {% if not selected_show %}selected{%endif %}>-- Select show --</option>
                                {% for s in shows %}
                                    <option value="{{ s.uuid }}" {% if s == selected_show %}selected{%endif %}>{{ s.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    {% if performances %}
                        <div class="row form-group">
                            <label class="col-4 form-control-label">Performance</label>
                            <div class="col-8">
                                <select id="sale-performance-select" class="form-control" onchange="saleSelectPerformance(this.value)">
                                    <option value="" {% if not selected_performance %}selected{%endif %}>-- Select performance --</option>
                                    {% for p in performances %}
                                        <option value="{{ p.uuid }}" {% if p == selected_performance %}selected{% endif %}>{{ p.date | date:'D, j M' }} at {{ p.time | time:'h:ip' }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    {% endif %}
                    {% if sale_tickets_form %}
                        {% crispy sale_tickets_form %}
                    {% endif %}
                </div>
            </div>
            <div class="card mb-2">
                <h6 class="card-header">Extras</h6>
                <div class="card-body">
                    {% crispy sale_extras_form %}
                </div>
            </div>
        {% endif %}
    </div>

    <div class="col-6">
        {% if not sale %}
            <div class="alert alert-info">
                <p>To start a new sale enter the customer name or e-mail address and click Start.</p>
                <p><strong>Important:</strong> if the customer wants to purchase tickets using an eFringer you must enter the e-mail address of the account used to purchase the eFringer.</p>
            </div>
        {% else %}
            {% if sale.completed %}
                <div class="alert alert-info">
                    <p>This sale is now complete but you can still make changes to correct mistakes until you enter the next checkpoint.</p>
                    <p>Select Close to begin a new sale.</p>
                </div>
            {% endif %}
            <div class="card">
                <h6 class="card-header"><i class="fa fa-user-circle {% if sale.customer_user %}text-primary{% endif %}"></i> {{ sale.customer }}</h6>
                <div class="card-body">
                    {% if sale.buttons %}
                        <div class="row mb-2">
                            <div class="col-9"><strong>{{ sale.buttons }} x Buttons</strong></div>
                            <div class="col-3 text-right">&#163;{{ sale.button_cost }}</div>
                        </div>
                    {% endif %}
                    {% if sale.fringers.count > 0 %}
                        <div class="row mb-2">
                            <div class="col-9"><strong>{{ sale.fringers.count }} x Paper fringers (6 shows for &#163;18)</strong></div>
                            <div class="col-3 text-right">&#163;{{ sale.fringer_cost }}</div>
                        </div>
                    {% endif %}
                    {% for performance in sale.performances %}
                        <div class="row mb-2">
                            <div class="col-9"><strong>{{ performance.show }}</strong></div>
                            <div class="col-3 text-right">&#163;{{ performance.ticket_cost }}</div>
                            <div class="col-6">{{ performance.date | date:'D, j M' }} at {{ performance.time | time:'h:ia' }}</div>
                            <div class="col-3"><a href="#tf-boxoffice-sale-tickets-{{ forloop.counter }}" data-toggle="collapse">{{ performance.tickets | length }} Tickets</a></div>
                            <div class="col-3 text-right">
                                {% if not sale.completed %}
                                    <a href="#" onclick="updateSalesTab('{% url "boxoffice:sale_remove_performance" sale.uuid performance.uuid %}')">Remove</a>
                                {% endif %}
                            </div>
                            <div id="tf-boxoffice-sale-tickets-{{ forloop.counter }}" class="col-12 collapse">
                                {% for ticket in performance.tickets %}
                                    <div class="row">
                                        <div class="col-1"></div>
                                        <div class="col-2">{{ ticket.id }}</div>
                                        <div class="col-4">{{ ticket.description }}</div>
                                        <div class="col-2 text-right">{% if ticket.cost %}&#163;{{ ticket.cost }}{% endif %}</div>
                                        <div class="col-3">
                                            {% if not sale.completed %}
                                                <a href="#" onclick="updateSalesTab('{% url "boxoffice:sale_remove_ticket" sale.uuid ticket.uuid %}')">Remove</a>
                                            {% endif %}
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    {% endfor %}
                    <div class="row mb-2">
                        <div class="col-9"><strong>Total</strong></div>
                        <div class="col-3 text-right">{% if sale %}&#163;{{ sale.total_cost }}{% endif %}</div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-12">
                            {% if sale.completed %}
                                <button class="btn btn-primary">E-mail</button>
                                <a class="btn btn-primary" href="{% url 'reports:sale_pdf' sale.uuid %}" target="_blank">PDF</a>
                                <div class="float-right">
                                    <a class="btn btn-secondary" href="#" onclick="updateSalesTab('{% url "boxoffice:sale_close" sale.uuid %}')">Close</a>
                                </div>
                            {% else %}
                                <a class="btn btn-primary" href="#" onclick="updateSalesTab('{% url "boxoffice:sale_complete" sale.uuid %}')">Complete</a>
                                <a class="btn btn-primary" href="#" onclick="updateSalesTab('{% url "boxoffice:sale_cancel" sale.uuid %}')">Cancel</a>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        {% endif %}
    </div>
</div>

<script language="javascript">

    {% if not sale %}

        function saleStart() {
            var postData = $('#sale-start-form').serializeArray();
            updateSalesTab('{% url "boxoffice:sale_start" boxoffice.uuid %}', postData);
        }

    {% else %}

        function saleSelectShow(showUuid) {
            updateSalesTab('{% url "boxoffice:sale_show_select" sale.uuid "00000000-0000-0000-0000-000000000000" %}'.replace('00000000-0000-0000-0000-000000000000', showUuid));
        }

        function saleSelectPerformance(performanceUuid) {
            updateSalesTab('{% url "boxoffice:sale_performance_select" sale.uuid "00000000-0000-0000-0000-000000000000" %}'.replace('00000000-0000-0000-0000-000000000000', performanceUuid));
        }

        {% if sale_tickets_form %}
            function saleAddTickets() {
                var postData = $('#sale-tickets-form').serializeArray();
                updateSalesTab('{% url "boxoffice:sale_tickets_add" sale.uuid selected_performance.uuid %}', postData);
            }
        {% endif %}

        {% if sale_extras_form %}
            function saleUpdateExtras() {
                var postData = $('#sale-extras-form').serializeArray();
                updateSalesTab('{% url "boxoffice:sale_extras_update" sale.uuid %}', postData);
            }
        {% endif %}

    {% endif %}

</script>